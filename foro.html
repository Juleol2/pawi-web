<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAWI - Foro Comunitario</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS (Mantenemos los mismos de antes) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #f4f6f8; color: #333; min-height: 100vh; display: flex; flex-direction: column; }

        /* NAVBAR */
        .navbar { background-color: #ffffff; height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .nav-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-shrink: 0; }
        .logo-img { height: 45px; width: auto; } 
        .logo-text-img { height: 30px; width: auto; margin-top: 5px; }
        .nav-icon-btn { font-size: 22px; text-decoration: none; color: #555; transition: all 0.2s; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background-color: #f4f6f8; }
        .nav-icon-btn:hover { transform: scale(1.1); background-color: #FFF0E6; color: #F59E2D; }
        .back-btn svg { stroke: #555; transition: stroke 0.2s; }
        .back-btn:hover svg { stroke: #F59E2D; }
        .alert-btn { color: #dc2626; background-color: #fef2f2; animation: pulse-red 2s infinite; }
        .alert-btn:hover { background-color: #fee2e2; color: #b91c1c; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-user-badge { display: flex; align-items: center; gap: 8px; background-color: #FFF0E6; padding: 8px 15px; border-radius: 30px; color: #F59E2D; font-weight: 700; font-size: 14px; white-space: nowrap; cursor: pointer; transition: all 0.2s ease; }
        .nav-user-badge:hover { background-color: #F59E2D; color: white; }

        /* LAYOUT */
        .forum-container { max-width: 1200px; margin: 30px auto; width: 100%; padding: 0 20px; display: grid; grid-template-columns: 250px 1fr 300px; gap: 30px; align-items: start; }
        .sidebar-left { background: transparent; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 100px; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: #666; text-decoration: none; font-weight: 600; border-radius: 15px; transition: 0.2s; cursor: pointer; }
        .menu-item:hover, .menu-item.active { background-color: white; color: #F59E2D; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .menu-item.active { border-left: 4px solid #F59E2D; }
        .menu-icon { font-size: 20px; width: 30px; text-align: center; }
        
        .feed-center { display: flex; flex-direction: column; gap: 20px; }
        
        /* Crear Post */
        .create-post-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: flex-start; }
        .user-avatar { width: 50px; height: 50px; background-color: #1F2937; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; object-fit: cover; flex-shrink: 0; }
        .post-input-container { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .post-input { width: 100%; background-color: #f4f6f8; border: 1px solid transparent; padding: 15px; border-radius: 15px; outline: none; transition: 0.2s; resize: none; font-family: inherit; }
        .post-input:focus { background-color: white; border-color: #F59E2D; }
        .post-submit-btn { align-self: flex-end; background-color: #F59E2D; color: white; border: none; padding: 8px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
        
        /* POSTS */
        .post-card { background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .post-header { padding: 20px; display: flex; align-items: center; gap: 15px; }
        .post-author { font-weight: 700; color: #111; }
        .post-time { font-size: 12px; color: #999; }
        .post-content { padding: 0 20px 20px; color: #444; line-height: 1.5; }
        .post-img { width: 100%; height: 350px; object-fit: cover; }
        .post-actions { padding: 15px 20px; border-top: 1px solid #eee; display: flex; gap: 20px; color: #666; font-size: 14px; font-weight: 600; }
        
        /* ALERTAS ESPECIFICAS */
        .alert-post { border: 2px solid #ef4444; }
        .alert-banner { background-color: #fef2f2; color: #dc2626; padding: 12px 20px; font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #fee2e2; border-top: 1px solid #fee2e2; }
        .btn-action-alert { border: none; background: none; cursor: pointer; display: flex; gap: 5px; align-items: center; font-weight: 700; transition: 0.2s; }
        .btn-action-alert:hover { transform: scale(1.05); }

        /* SIDEBAR ADS */
        .sidebar-right { display: flex; flex-direction: column; gap: 20px; position: sticky; top: 100px; }
        .ad-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .ad-header { font-size: 12px; font-weight: 700; color: #999; margin-bottom: 15px; text-transform: uppercase; }
        .ad-item { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .ad-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; background-color: #eee; }
        .ad-info h4 { font-size: 14px; margin-bottom: 3px; }
        .ad-info p { font-size: 11px; color: #666; line-height: 1.4; }

        @media (max-width: 992px) { .forum-container { grid-template-columns: 1fr; } .sidebar-left, .sidebar-right { display: none; } }
    </style>
</head>
<body>

   <nav class="navbar">
    <div class="nav-left">
        <a href="dashboard.html" class="nav-icon-btn back-btn" title="Volver al Dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </a>
        <a href="dashboard.html" class="nav-logo">
            <img src="logoImagen.png" alt="Logo" class="logo-img">
            <img src="logoNombre.png" alt="PAWI" class="logo-text-img">
        </a>
    </div>
    <div class="nav-links">
        <a href="generar_alerta.html" class="nav-icon-btn alert-btn" title="Generar Alerta">üö®</a>
        <div class="nav-user-badge"><span>üë§ <span id="navUserName">Cargando...</span></span></div>
        <a href="login.html" class="nav-icon-btn logout-btn" title="Salir">üö™</a>
    </div>
</nav>

    <div class="forum-container">
        
        <div class="sidebar-left">
            <a href="#" class="menu-item active"><span class="menu-icon">üì∞</span> Feed Principal</a>
            <a href="#" class="menu-item" onclick="alert('En desarrollo')"><span class="menu-icon">üì¢</span> Alertas Activas</a>
            <a href="#" class="menu-item" onclick="alert('En desarrollo')"><span class="menu-icon">üîñ</span> Guardados</a>
            <a href="#" class="menu-item" onclick="alert('Soporte: 0993919389')"><span class="menu-icon">üéß</span> Soporte T√©cnico</a>
        </div>

        <div class="feed-center">
            
            <div class="create-post-card">
                <div class="user-avatar" id="forumUserInitials">?</div>
                <div class="post-input-container">
                    <textarea class="post-input" placeholder="¬øQu√© est√°s pensando?" rows="2"></textarea>
                    <button class="post-submit-btn" onclick="alert('En desarrollo')">Publicar</button>
                </div>
            </div>

            <div id="feedDinamico" class="feed-container" style="margin-top: 20px;">
                <p style="text-align:center; padding: 30px; color:#888;">Cargando feed...</p>
            </div>

        </div>

        <div class="sidebar-right">
            <div class="ad-card">
                <div class="ad-header">Publicidad Sugerida</div>
                <div class="ad-item">
                    <img src="https://images.unsplash.com/photo-1583337130417-3346a1be7dee?auto=format&fit=crop&w=200&q=80" class="ad-img">
                    <div class="ad-info">
                        <h4>VetCare 24/7</h4>
                        <p>Chequeo general a mitad de precio.</p>
                        <a href="#" style="font-size:10px; color:#F59E2D; font-weight:700;">veterinaria.com</a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="main.js"></script>

    <script type="module">
        import { db, auth } from './firebase.js';
        import { collection, query, where, orderBy, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Ejecutar carga cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            cargarFeedMixto();
        });

        async function cargarFeedMixto() {
            const contenedor = document.getElementById('feedDinamico');
            
            try {
                // 1. Obtener Alertas de Firebase
                const q = query(collection(db, "alerts"), where("status", "==", "active"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                
                let items = [];

                snap.forEach(docSnap => {
                    items.push({ type: 'alert', id: docSnap.id, ...docSnap.data() });
                });

                // 2. Datos Simulados (Posts Generales)
                const postsFalsos = [
                    {
                        type: 'vet', authorName: "Dra. Sof√≠a M√©ndez", role: "Veterinaria", time: "Hace 2 horas",
                        content: "‚ö†Ô∏è Tip: Si tu mascota presiona su cabeza contra la pared, acude al veterinario urgente.",
                        likes: 120, avatar: "https://randomuser.me/api/portraits/women/68.jpg"
                    },
                    {
                        type: 'social', authorName: "Carlos Ruiz", time: "Ayer",
                        content: "¬°Tarde de parque con Max! üå≥‚òÄÔ∏è",
                        likes: 45, image: "https://images.unsplash.com/photo-1548199973-03cce0bbc87b?auto=format&fit=crop&w=800&q=80",
                        avatar: "https://randomuser.me/api/portraits/men/32.jpg"
                    }
                ];

                // Unimos todo
                const feedFinal = [...items, ...postsFalsos];
                contenedor.innerHTML = "";

                if (feedFinal.length === 0) {
                    contenedor.innerHTML = "<p style='text-align:center'>No hay actividad.</p>";
                    return;
                }

                // 3. Renderizar
                feedFinal.forEach(item => {
                    if (item.type === 'alert') {
                        // RENDERIZAR ALERTA (Dise√±o Rojo)
                        const inicial = (item.authorName || "U").charAt(0).toUpperCase();
                        const uid = auth.currentUser ? auth.currentUser.uid : null;
                        const yaSumado = item.apoyosUsuarios ? item.apoyosUsuarios.includes(uid) : false;

                        contenedor.innerHTML += `
                            <div class="post-card alert-post" style="border: 2px solid #ef4444; border-radius: 24px; overflow: hidden; margin-bottom: 30px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.05);">
                                <div class="post-header" style="padding: 20px; display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 45px; height: 45px; background: #111827; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px;">${inicial}</div>
                                    <div>
                                        <div style="font-weight: 800; color: #111;">${item.authorName}</div>
                                        <div style="font-size: 12px; color: #dc2626; font-weight: 700;">üö® ALERTA ACTIVA ‚Ä¢ Hace un momento</div>
                                    </div>
                                </div>
                                <div style="padding: 0 20px 15px; color: #333; font-size: 15px;">${item.content}</div>
                                <div style="background: #fef2f2; color: #dc2626; padding: 12px 20px; font-weight: 700; font-size: 13px; border-top: 1px solid #fee2e2; border-bottom: 1px solid #fee2e2;">
                                    üìç Visto en: ${item.lastSeenLocation}
                                </div>
                                <div style="width: 100%; height: auto; min-height: 300px; background: #f3f4f6;">
                                    <img src="${item.petPhoto}" style="width: 100%; height: auto; max-height: 500px; object-fit: cover; display: block;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: white;">
                                    <button onclick="window.location.href='mailto:${item.ownerEmail}'" style="border: none; background: none; font-weight: 700; cursor: pointer; color: #dc2626;">üìû Contactar</button>
                                    <button onclick="window.sumarse('${item.id}')" ${yaSumado ? 'disabled' : ''} style="color: white; background: ${yaSumado ? '#9ca3af' : '#4caf50'}; padding: 8px 20px; border-radius: 30px; border: none; font-weight: 700; cursor: pointer;">
                                        üêæ ${yaSumado ? 'Sumado' : 'Me sumo'} (${item.apoyos || 0})
                                    </button>
                                </div>
                            </div>`;
                    } else {
                        // RENDERIZAR POST GENERAL (Dise√±o Normal)
                        contenedor.innerHTML += `
                            <div class="post-card" style="border-radius: 20px; margin-bottom: 30px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow:hidden;">
                                <div style="padding: 20px; display: flex; align-items: center; gap: 15px;">
                                    <img src="${item.avatar}" style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
                                    <div>
                                        <div style="font-weight: 700; color: #111;">${item.authorName} ${item.role ? `<span style="background:#e0f2fe; color:#0284c7; font-size:10px; padding:2px 6px; border-radius:10px;">${item.role}</span>` : ''}</div>
                                        <div style="font-size: 12px; color: #999;">${item.time}</div>
                                    </div>
                                </div>
                                <div style="padding: 0 20px 20px; color: #444; font-size: 15px;">${item.content}</div>
                                ${item.image ? `<img src="${item.image}" style="width: 100%; height: 250px; object-fit: cover;">` : ''}
                                <div style="padding: 15px 20px; border-top: 1px solid #f3f4f6; color: #666; font-size: 13px; font-weight: 600;">
                                    ‚ù§Ô∏è ${item.likes} Me gusta
                                </div>
                            </div>`;
                    }
                });

            } catch (e) {
                console.error("Error foro:", e);
                contenedor.innerHTML = "<p style='color:red; text-align:center'>‚ö†Ô∏è Error al cargar. Revisa la consola (F12) por si falta el √çndice en Firebase.</p>";
            }
        }

        // Funci√≥n Global para el bot√≥n
        window.sumarse = async (id) => {
            if(!auth.currentUser) return alert("Inicia sesi√≥n primero");
            try {
                const ref = doc(db, "alerts", id);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const d = snap.data();
                    const usrs = d.apoyosUsuarios || [];
                    if(!usrs.includes(auth.currentUser.uid)) {
                        await updateDoc(ref, { apoyos: (d.apoyos||0)+1, apoyosUsuarios: [...usrs, auth.currentUser.uid] });
                        cargarFeedMixto();
                    }
                }
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>